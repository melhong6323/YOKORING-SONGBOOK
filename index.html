<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìš”ì½”ë§ ë…¸ë˜ì±…</title>
<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;background:#0f1115;color:#eaeaf0;overflow:hidden;}
.title-line{display:flex;align-items:center;justify-content:center;gap:16px;margin:24px 0 16px;font-size:28px;color:#eaeaf0;position:sticky;top:0;background:#0f1115;z-index:50;padding:8px 0;}
.youtube-btn{display:flex;align-items:center;gap:6px;background:#ff4f9a;color:#000;font-weight:600;font-size:16px;padding:6px 12px;border-radius:8px;text-decoration:none;transition:transform 0.15s, background 0.15s;}
.youtube-btn:hover{transform:scale(1.05);background:#ff78b2;}

.container{display:flex;gap:16px;max-width:1200px;margin:0 auto;padding:0 16px 16px;height:calc(100vh - 80px);}
.left-pane{flex:1;max-width:33%;display:flex;flex-direction:column;overflow:hidden;gap:12px;}
.right-pane{flex:2;max-width:67%;display:flex;flex-direction:column;overflow:hidden;margin-right:220px;}

#tabs{display:flex;flex-wrap:wrap;gap:8px;}
.tab{padding:8px 14px;border-radius:20px;background:#1f2330;color:#cfd3ff;cursor:pointer;font-size:14px;user-select:none;transition: 0.2s;}
.tab.active{background:#ff4f9a;color:#000;font-weight:600;}
.top-controls{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-bottom:12px;}
#searchInput{margin-left:auto;padding:8px 12px;border-radius:8px;border:1px solid #333;background:#181b22;color:#fff;font-size:14px;flex-shrink:0;}
#toggleLargeText{margin-left:8px;padding:8px 12px;border-radius:6px;background:#ff4f9a;color:#000;border:none;cursor:pointer;font-size:14px;font-weight:600;}

.guide{background:#181b22;border-radius:12px;padding:16px;font-size:14px;line-height:1.6;color:#cfd3ff;overflow-y:auto;flex-shrink:0;border:1px solid #232736;}
.artist-controls{display:flex;gap:8px;margin-bottom:6px;}
#btnGanada{padding:6px 12px;border-radius:14px;background:#1f2330;color:#cfd3ff;border:none;cursor:pointer;transition:0.15s;}
#btnGanada:hover{background:#6c7bff;color:#000;font-weight:600;}
.artist-list{display:flex;flex-wrap:wrap;gap:6px;max-height:550px;overflow-y:auto;}
.artist{padding:6px 12px;border-radius:14px;background:#1f2330;font-size:13px;cursor:pointer;color:#cfd3ff;white-space:nowrap;}
.artist.active{background:#6c7bff;color:#000;font-weight:600;}

/* ë…¸ë˜ ëª©ë¡ ìŠ¤íƒ€ì¼ ìˆ˜ì • (ë³µì‚¬ ë²„íŠ¼ ì—´ ì¶”ê°€) */
#list{flex:1;overflow-y:auto;background:#0f1115;border-radius:8px;}
.song{display:grid;grid-template-columns:40px 1.4fr 2fr auto auto auto auto auto;gap:8px;padding:14px 8px;border-bottom:1px solid #232736;align-items:center;font-size:15px;transition:background 0.2s;cursor:pointer;min-height:48px;}
.song:nth-child(odd){background:#15181f;}
.song:hover{background:#1f2330 !important;}
.song strong{font-size:15.5px;font-weight:600;color:#fff;}
.song>div{font-size:14.5px;color:#eaeaf0;}
.song small{font-size:12.5px;color:#aab0ff;}

/* ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.copy-btn{background:none;border:none;color:#555;cursor:pointer;font-size:16px;padding:0;display:flex;align-items:center;justify-content:center;transition:color 0.2s;}
.copy-btn:hover{color:#ff4f9a;}

.mr,.lyrics-btn{color:#ff4f9a;font-weight:bold;cursor:pointer;white-space:nowrap;font-size:14px;}
.disabled{color:#444;pointer-events:none;font-weight:normal;}
.song.selected{background:#251c2a !important;border-left:4px solid #ff4f9a;box-shadow:inset 0 0 10px rgba(255,79,154,0.1);}
.song.selected strong{color:#ff4f9a;}

/* í° ê¸€ì”¨ ëª¨ë“œ */
.right-pane.broadcast-mode .song{grid-template-columns:50px 1.4fr 2fr auto auto auto auto auto;}
.right-pane.broadcast-mode .song strong,.right-pane.broadcast-mode .song>div,.right-pane.broadcast-mode .song small{font-size:1.35em;}
.right-pane.broadcast-mode .mr,.right-pane.broadcast-mode .lyrics-btn,.right-pane.broadcast-mode .copy-btn{font-size:1.45em;}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:#181b22;padding:30px 40px;max-width:600px;max-height:80%;overflow-y:auto;border-radius:12px;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);white-space:pre-wrap;border:2px solid #ff4f9a;box-shadow:0 0 30px rgba(0,0,0,0.5);cursor:default;}
.modal-close{position:absolute;top:10px;right:15px;cursor:pointer;font-weight:bold;color:#ff4f9a;font-size:20px;}
#lyricsText{padding:14px 0;font-size:16px;line-height:1.8;color:#f1f2ff;text-align:center;}

.right-pane::after{content:"";display:block;width:220px;height:0;}

@media(max-width:720px){
  .container{flex-direction:column;}
  .left-pane,.right-pane{max-width:100%;flex:unset;height:auto;margin-right:0;}
  .song{grid-template-columns:30px 1fr 1.6fr auto auto auto;}
}
</style>
</head>
<body>

<h1 class="title-line">
ìš”ì½”ë§ ë…¸ë˜ì±…
<a href="https://www.youtube.com/@%EC%9A%94%EC%BD%94%EB%A7%81" target="_blank" class="youtube-btn">â–¶ ìš”ì½”ë§ YouTube</a>
</h1>

<div class="container">
  <div class="left-pane">
    <div id="tabs"></div>
    <div class="artist-controls">
      <button id="btnGanada">ê°€ë‚˜ë‹¤ìˆœ</button>
    </div>
    <div class="artist-list" id="artistList"></div>
    <div id="guide" class="guide"></div>
  </div>
  <div class="right-pane">
    <div class="top-controls">
      <input type="text" id="searchInput" placeholder="ê³¡ ì œëª© ë˜ëŠ” ê°€ìˆ˜ ê²€ìƒ‰">
      <button id="toggleLargeText">í° ê¸€ì”¨ëª¨ë“œ</button>
    </div>
    <div id="list"></div>
  </div>
</div>

<div id="ganadaModal" class="modal">
  <div class="modal-content" id="ganadaContent">
    <span id="ganadaClose" class="modal-close">âœ•</span>
    <div id="ganadaList" style="display:flex;flex-wrap:wrap;gap:6px;max-height:500px;overflow-y:auto;"></div>
  </div>
</div>

<div id="lyricsModal" class="modal">
  <div class="modal-content">
    <span id="modalClose" class="modal-close">âœ•</span>
    <pre id="lyricsText"></pre>
  </div>
</div>

<script>
const SHEET_ID='1bSs04gJ8HyVil5PM0TBAm-4c_BeAqbU7ENMZ2AQcUVI';
const SHEET_NAMES=['ì‚¬ìš©ì„¤ëª…ì„œ','K-POP','POP','J-POP','ìˆ™ì œê³¡','ì‹ ê³¡'];
const guideEl=document.getElementById('guide'),tabsEl=document.getElementById('tabs'),
listEl=document.getElementById('list'),artistListEl=document.getElementById('artistList'),
btnGanada=document.getElementById('btnGanada'),
ganadaModal=document.getElementById('ganadaModal'),ganadaClose=document.getElementById('ganadaClose'),
ganadaList=document.getElementById('ganadaList'),
lyricsModal=document.getElementById('lyricsModal'),lyricsText=document.getElementById('lyricsText'),
modalClose=document.getElementById('modalClose'),
searchInput=document.getElementById('searchInput'),toggleBtn=document.getElementById('toggleLargeText');

let currentSongs=[],currentArtist='ì „ì²´',artistMap={},largeTextOn=false,lyricsList=[];

async function fetchSheet(sheetName){
  const res=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx:out:json&sheet=${encodeURIComponent(sheetName)}`);
  const text=await res.text();
  const json=JSON.parse(text.substring(47,text.length-2));
  return json.table.rows.map(r=>r.c.map(c=>c?c.v:''));
}

async function loadLyricsList(){
  try{ lyricsList=await(await fetch('data/lyrics_list.json')).json(); }catch(e){ console.log("ê°€ì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨"); }
}

function findLyricsFile(artist,title){
  const f=lyricsList.find(l=>l.artist===artist&&l.title===title);
  return f?f.file:null;
}

function normalizeArtist(name){
  return String(name).replace(/(\([^)]*feat[^)]*\))/i,'').replace(/feat.*$/i,'').trim();
}

async function selectCategory(name,tabEl){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tabEl.classList.add('active');
  currentArtist='ì „ì²´'; currentSongs=[];
  const rows=await fetchSheet(name);
  rows.slice(1).forEach(r=>{
    if(!r[0]||!r[1]) return;
    currentSongs.push({
      artist:String(r[0]), title:String(r[1]), memo:r[2]||'', 
      keyUp:r[3]||'', key:r[4]||'', mr:r[5]||'', 
      lyricsFile:findLyricsFile(String(r[0]),String(r[1]))
    });
  });
  renderArtistFilter(currentSongs);
  renderSongList(searchInput.value.toLowerCase());
}

function renderTabs(){
  SHEET_NAMES.slice(1).forEach(name=>{
    const tab=document.createElement('div');
    tab.className='tab'; tab.textContent=name;
    tab.onclick=()=>selectCategory(name,tab);
    tabsEl.appendChild(tab);
  });
}

async function loadGuide(){
  const rows=await fetchSheet('ì‚¬ìš©ì„¤ëª…ì„œ');
  guideEl.innerHTML=rows.map(r=>r.join(' ')).join('<br>');
}

function renderArtistFilter(songs){
  artistMap={};
  songs.forEach(s=>{const k=normalizeArtist(s.artist); artistMap[k]=(artistMap[k]||0)+1; s.filterArtist=k;});
  let sortedArtists=Object.entries(artistMap).sort((a,b)=>b[1]-a[1]).map(e=>e[0]);
  artistListEl.innerHTML='';
  sortedArtists.forEach(a=>{
    const btn=document.createElement('div'); btn.className='artist'; btn.textContent=a;
    if(currentArtist===a) btn.classList.add('active');
    btn.onclick=()=>{
      if(currentArtist===a){ currentArtist='ì „ì²´'; renderArtistFilter(songs); renderSongList(searchInput.value.toLowerCase()); }
      else{ currentArtist=a; renderArtistFilter(songs); renderSongList(searchInput.value.toLowerCase()); btn.scrollIntoView({behavior:'smooth',block:'center'});}
    };
    artistListEl.appendChild(btn);
  });
}

// ë…¸ë˜ ëª©ë¡ ë Œë”ë§ (ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€)
function renderSongList(searchQuery=''){
  listEl.innerHTML='';
  const filtered=currentSongs.filter(s=>(currentArtist==='ì „ì²´'||s.filterArtist===currentArtist)&&(s.title.toLowerCase().includes(searchQuery)||s.artist.toLowerCase().includes(searchQuery)));
  filtered.forEach((s)=>{
    const div=document.createElement('div'); div.className='song';
    const mrBtn=s.mr?`<a class="mr" href="${s.mr}" target="_blank">MR</a>`:`<span class="mr disabled">MR</span>`;
    const lyricsBtn=s.lyricsFile?`<span class="lyrics-btn" onclick="showLyrics('${s.lyricsFile}')">ê°€ì‚¬</span>`:`<span class="lyrics-btn disabled">ê°€ì‚¬</span>`;
    
    // ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€
    const copyBtn = `<button class="copy-btn" onclick="copyToClipboard('${s.artist} - ${s.title}', this); event.stopPropagation();" title="ê°€ìˆ˜-ì œëª© ë³µì‚¬">ğŸ“‹</button>`;
    
    div.innerHTML=`${copyBtn}<strong>${s.artist}</strong><div>${s.title}</div><small class="memo">${s.memo}</small><small>${s.keyUp}</small><small>${s.key}</small>${mrBtn}${lyricsBtn}`;
    listEl.appendChild(div);
    div.onclick=()=>{
      document.querySelectorAll('.song').forEach(x=>x.classList.remove('selected'));
      div.classList.add('selected');
    };
  });
}

// í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
function copyToClipboard(text, btnEl) {
  navigator.clipboard.writeText(text).then(() => {
    const originalText = btnEl.textContent;
    btnEl.textContent = 'âœ…'; // ì„±ê³µ í‘œì‹œ
    setTimeout(() => { btnEl.textContent = originalText; }, 1000);
  }).catch(err => {
    console.error('ë³µì‚¬ ì‹¤íŒ¨: ', err);
  });
}

function showLyrics(file){
  fetch(`data/lyrics/${file}`).then(r=>r.text()).then(text=>{
    lyricsText.textContent=text; lyricsModal.style.display='flex';
  }).catch(()=>{
    lyricsText.textContent='ê°€ì‚¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; lyricsModal.style.display='flex';
  });
}

let isDragging=false, targetContent=null, offsetX=0, offsetY=0;
document.querySelectorAll('.modal-content').forEach(mc=>{
  mc.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('modal-close')) return;
    isDragging=true; targetContent=mc;
    const rect=mc.getBoundingClientRect();
    mc.style.position='fixed'; mc.style.left=rect.left+'px'; mc.style.top=rect.top+'px'; mc.style.transform='none'; mc.style.margin='0';
    offsetX=e.clientX-rect.left; offsetY=e.clientY-rect.top;
  });
});
document.addEventListener('mousemove',e=>{
  if(!isDragging||!targetContent)return;
  const vw=window.innerWidth, vh=window.innerHeight;
  const mw=targetContent.offsetWidth, mh=targetContent.offsetHeight;
  let l=e.clientX-offsetX, t=e.clientY-offsetY;
  l=Math.max(0,Math.min(l,vw-mw)); t=Math.max(0,Math.min(t,vh-mh));
  targetContent.style.left=l+'px'; targetContent.style.top=t+'px';
});
document.addEventListener('mouseup',()=>{isDragging=false; targetContent=null;});

btnGanada.onclick=()=>{
  ganadaList.innerHTML='';
  const allArtists=Object.keys(artistMap).sort((a,b)=>a.localeCompare(b,'ko'));
  allArtists.forEach(a=>{
    const btn=document.createElement('div'); btn.className='artist'; btn.textContent=a;
    btn.onclick=()=>{
      currentArtist=a; renderArtistFilter(currentSongs); renderSongList(searchInput.value.toLowerCase());
      ganadaModal.style.display='none';
      setTimeout(() => {
        const artists = artistListEl.querySelectorAll('.artist');
        artists.forEach(el => { if (el.textContent === a) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
      }, 150);
    };
    ganadaList.appendChild(btn);
  });
  ganadaModal.style.display='flex';
};

ganadaClose.onclick=()=>ganadaModal.style.display='none';
modalClose.onclick=()=>lyricsModal.style.display='none';
window.onclick=e=>{ if(e.target===lyricsModal) lyricsModal.style.display='none'; if(e.target===ganadaModal) ganadaModal.style.display='none'; };
searchInput.addEventListener('input',()=>renderSongList(searchInput.value.toLowerCase()));
toggleBtn.onclick=()=>{
  largeTextOn=!largeTextOn;
  document.querySelector('.right-pane').classList.toggle('broadcast-mode',largeTextOn);
};

(async()=>{ await loadLyricsList(); renderTabs(); loadGuide(); })();
</script>
</body>
</html>
