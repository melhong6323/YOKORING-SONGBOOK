<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìš”ì½”ë§ ë…¸ë˜ì±…</title>
<style>
/* 1. ë””ìì¸ ë° ë ˆì´ì•„ì›ƒ */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;background:#0f1115;color:#eaeaf0;overflow:hidden;}
.title-line{display:flex;align-items:center;justify-content:center;gap:16px;margin:24px 0 16px;font-size:28px;color:#eaeaf0;position:sticky;top:0;background:#0f1115;z-index:50;padding:8px 0;}
.youtube-btn{display:flex;align-items:center;gap:6px;background:#ff4f9a;color:#000;font-weight:600;font-size:16px;padding:6px 12px;border-radius:8px;text-decoration:none;transition:transform 0.15s, background 0.15s;}
.youtube-btn:hover{transform:scale(1.05);background:#ff78b2;}

.container{display:flex;gap:16px;max-width:1200px;margin:0 auto;padding:0 16px 16px;height:calc(100vh - 80px);}
.left-pane{flex:1;max-width:33%;display:flex;flex-direction:column;overflow:hidden;gap:12px;}
.right-pane{flex:2;max-width:67%;display:flex;flex-direction:column;overflow:hidden;margin-right:220px;}

#tabs{display:flex;flex-wrap:wrap;gap:8px;}
.tab{padding:8px 14px;border-radius:20px;background:#1f2330;color:#cfd3ff;cursor:pointer;font-size:14px;user-select:none;transition: 0.2s;}
.tab.active{background:#ff4f9a;color:#000;font-weight:600;}

.top-controls{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-bottom:12px;}
#searchInput{margin-left:auto;padding:8px 12px;border-radius:8px;border:1px solid #333;background:#181b22;color:#fff;font-size:14px;}
#toggleLargeText{margin-left:8px;padding:8px 12px;border-radius:6px;background:#ff4f9a;color:#000;border:none;cursor:pointer;font-size:14px;font-weight:600;}

.guide{background:#181b22;border-radius:12px;padding:16px;font-size:14px;line-height:1.6;color:#cfd3ff;overflow-y:auto;flex-shrink:0;border:1px solid #232736;}
.artist-controls{display:flex;gap:8px;margin-bottom:6px;}
#btnGanada{padding:6px 12px;border-radius:14px;background:#1f2330;color:#cfd3ff;border:none;cursor:pointer;transition:0.15s;}
#btnGanada:hover{background:#6c7bff;color:#000;font-weight:600;}
.artist-list{display:flex;flex-wrap:wrap;gap:6px;max-height:550px;overflow-y:auto;}
.artist{padding:6px 12px;border-radius:14px;background:#1f2330;font-size:13px;cursor:pointer;color:#cfd3ff;white-space:nowrap;}
.artist.active{background:#6c7bff;color:#000;font-weight:600;}

#list{flex:1;overflow-y:auto;background:#0f1115;border-radius:8px;}
.song{display:grid;grid-template-columns:40px 1.4fr 2fr auto auto auto auto auto;gap:8px;padding:14px 8px;border-bottom:1px solid #232736;align-items:center;font-size:15px;transition:background 0.2s;cursor:pointer;}
.song strong{font-size:15.5px;font-weight:600;color:#fff;}
.song.selected{background:#251c2a !important;border-left:4px solid #ff4f9a;}

.copy-btn{background:none;border:none;color:#555;cursor:pointer;font-size:16px;transition:color 0.2s;}
.copy-btn:hover{color:#ff4f9a;}
.mr,.lyrics-btn{color:#ff4f9a;font-weight:bold;cursor:pointer;font-size:14px;}
.disabled{color:#444;pointer-events:none;font-weight:normal;}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:#181b22;padding:30px 40px;max-width:600px;border-radius:12px;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:2px solid #ff4f9a;box-shadow:0 0 30px rgba(0,0,0,0.5);}
.modal-close{position:absolute;top:10px;right:15px;cursor:pointer;font-weight:bold;color:#ff4f9a;font-size:20px;}

/* í° ê¸€ì”¨ ëª¨ë“œ */
.right-pane.broadcast-mode .song strong,.right-pane.broadcast-mode .song>div{font-size:1.35em;}
.right-pane.broadcast-mode .mr,.right-pane.broadcast-mode .lyrics-btn{font-size:1.45em;}
</style>
</head>
<body>

<h1 class="title-line">
  ìš”ì½”ë§ ë…¸ë˜ì±…
  <a href="https://www.youtube.com/@%EC%9A%94%EC%BD%94%EB%A7%81" target="_blank" class="youtube-btn">â–¶ YouTube</a>
</h1>

<div class="container">
  <div class="left-pane">
    <div id="tabs"></div>
    <div class="artist-controls"><button id="btnGanada">ê°€ë‚˜ë‹¤ìˆœ</button></div>
    <div class="artist-list" id="artistList"></div>
    <div id="guide" class="guide"></div>
  </div>
  <div class="right-pane">
    <div class="top-controls">
      <input type="text" id="searchInput" placeholder="ê°€ìˆ˜ ë˜ëŠ” ì œëª© ê²€ìƒ‰">
      <button id="toggleLargeText">í° ê¸€ì”¨ëª¨ë“œ</button>
    </div>
    <div id="list"></div>
  </div>
</div>

<div id="ganadaModal" class="modal">
  <div class="modal-content">
    <span id="ganadaClose" class="modal-close">âœ•</span>
    <div id="ganadaList" style="display:flex;flex-wrap:wrap;gap:6px;max-height:500px;overflow-y:auto;"></div>
  </div>
</div>

<div id="lyricsModal" class="modal">
  <div class="modal-content">
    <span id="modalClose" class="modal-close">âœ•</span>
    <pre id="lyricsText" style="text-align:center;white-space:pre-wrap;color:#f1f2ff;"></pre>
  </div>
</div>

<script>
const SHEET_ID='1bSs04gJ8HyVil5PM0TBAm-4c_BeAqbU7ENMZ2AQcUVI';
const SHEET_NAMES=['ì‚¬ìš©ì„¤ëª…ì„œ','K-POP','POP','J-POP','ìˆ™ì œê³¡','ì‹ ê³¡'];
let currentSongs=[], currentArtist='ì „ì²´', artistMap={}, lyricsList=[];

// 1. ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ (vì™€ fë¥¼ ëª¨ë‘ ê°€ì ¸ì™€ ì¹© ì¸ì‹ ë³´ê°•)
async function fetchSheet(sheetName){
  const res=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`);
  const text=await res.text();
  const json=JSON.parse(text.substring(47,text.length-2));
  return json.table.rows.map(r => r.c);
}

// 2. ê°€ì‚¬ ëª©ë¡ ë¡œë“œ
async function loadLyricsList(){
  try{ lyricsList=await(await fetch('data/lyrics_list.json')).json(); }catch(e){ console.log("ê°€ì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨"); }
}

function findLyricsFile(artist,title){
  const f=lyricsList.find(l=>l.artist===artist&&l.title===title);
  return f?f.file:null;
}

// 3. ì¹´í…Œê³ ë¦¬ ì„ íƒ ë° ì´ì¤‘ ë§í¬ ì¸ì‹ (Fì—´ ì¹© + Gì—´ ë°±ì—…)
async function selectCategory(name, tabEl){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tabEl.classList.add('active');
  const rows = await fetchSheet(name);
  currentArtist='ì „ì²´';
  
  currentSongs = rows.slice(1).map(r => {
    if(!r || !r[0] || !r[1]) return null;

    // Fì—´(r[5])ì—ì„œ ì¹© ë‚´ë¶€ ì£¼ì†Œ ì¶”ì¶œ ì‹œë„
    let mrLink = '';
    const cellF = r[5];
    if (cellF && String(cellF.v || '').startsWith('http')) mrLink = String(cellF.v);
    else if (cellF && String(cellF.f || '').startsWith('http')) mrLink = String(cellF.f);

    // Fì—´ ì‹¤íŒ¨ ì‹œ Gì—´(r[6]) ë°±ì—… í™•ì¸
    if (!mrLink && r[6] && String(r[6].v || '').startsWith('http')) mrLink = String(r[6].v);

    return {
      artist: String(r[0].v || ''), 
      title: String(r[1].v || ''), 
      memo: (r[2]?.v || '') + (r[2]?.f || ''), 
      keyUp: String(r[3]?.v || ''), 
      key: String(r[4]?.v || ''), 
      mr: mrLink,
      lyricsFile: findLyricsFile(String(r[0].v || ''), String(r[1].v || '')),
      filterArtist: String(r[0].v || '').replace(/(\([^)]*feat[^)]*\))/i,'').trim()
    };
  }).filter(s => s !== null);

  renderArtistFilter(); renderSongList();
}

// 4. ì•„í‹°ìŠ¤íŠ¸ í•„í„° ë Œë”ë§
function renderArtistFilter(){
  artistMap={};
  currentSongs.forEach(s=>{ artistMap[s.filterArtist]=(artistMap[s.filterArtist]||0)+1; });
  const sortedArtists = Object.keys(artistMap).sort((a,b)=>artistMap[b]-artistMap[a]);
  const listEl = document.getElementById('artistList');
  listEl.innerHTML = '';
  
  const allBtn = document.createElement('div');
  allBtn.className = 'artist' + (currentArtist==='ì „ì²´'?' active':'');
  allBtn.textContent = `ì „ì²´ (${currentSongs.length})`;
  allBtn.onclick = () => { currentArtist='ì „ì²´'; renderArtistFilter(); renderSongList(); };
  listEl.appendChild(allBtn);

  sortedArtists.forEach(a => {
    const btn = document.createElement('div');
    btn.className = 'artist' + (currentArtist===a?' active':'');
    btn.textContent = `${a} (${artistMap[a]})`;
    btn.onclick = () => { currentArtist=a; renderArtistFilter(); renderSongList(); btn.scrollIntoView({behavior:'smooth',block:'center'}); };
    listEl.appendChild(btn);
  });
}

// 5. ë…¸ë˜ ëª©ë¡ ë Œë”ë§
function renderSongList(){
  const query = document.getElementById('searchInput').value.toLowerCase();
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  
  const filtered = currentSongs.filter(s => (currentArtist==='ì „ì²´' || s.filterArtist===currentArtist) && (s.title.toLowerCase().includes(query) || s.artist.toLowerCase().includes(query)));

  filtered.forEach(s => {
    const div = document.createElement('div');
    div.className = 'song';
    const mrBtn = s.mr ? `<a class="mr" href="${s.mr}" target="_blank">MR</a>` : `<span class="mr disabled">MR</span>`;
    const lyricsBtn = s.lyricsFile ? `<span class="lyrics-btn" onclick="showLyrics('${s.lyricsFile}')">ê°€ì‚¬</span>` : `<span class="lyrics-btn disabled">ê°€ì‚¬</span>`;
    
    div.innerHTML = `
      <button class="copy-btn" onclick="copyText('${s.artist}-${s.title}', this); event.stopPropagation();">ğŸ“‹</button>
      <strong>${s.artist}</strong>
      <div>${s.title}</div>
      <small style="color:#aab0ff;">${s.memo}</small>
      <small>${s.keyUp}</small>
      <small>${s.key}</small>
      ${mrBtn}${lyricsBtn}
    `;
    div.onclick = () => { document.querySelectorAll('.song').forEach(x=>x.classList.remove('selected')); div.classList.add('selected'); };
    listEl.appendChild(div);
  });
}

// 6. ë¶€ê°€ ê¸°ëŠ¥ (ë³µì‚¬, ê°€ì‚¬, í°ê¸€ì”¨, ê°€ë‚˜ë‹¤ìˆœ)
function copyText(txt, btn){
  navigator.clipboard.writeText(txt).then(() => {
    btn.textContent='âœ…'; setTimeout(()=>btn.textContent='ğŸ“‹', 1000);
  });
}

function showLyrics(file){
  fetch(`data/lyrics/${file}`).then(r=>r.text()).then(t=>{
    document.getElementById('lyricsText').textContent=t;
    document.getElementById('lyricsModal').style.display='flex';
  });
}

document.getElementById('btnGanada').onclick = () => {
  const ganadaList = document.getElementById('ganadaList');
  ganadaList.innerHTML = '';
  Object.keys(artistMap).sort((a,b)=>a.localeCompare(b,'ko')).forEach(a => {
    const btn = document.createElement('div'); btn.className='artist'; btn.textContent=a;
    btn.onclick=()=>{ currentArtist=a; renderArtistFilter(); renderSongList(); document.getElementById('ganadaModal').style.display='none'; };
    ganadaList.appendChild(btn);
  });
  document.getElementById('ganadaModal').style.display='flex';
};

document.getElementById('modalClose').onclick=()=>document.getElementById('lyricsModal').style.display='none';
document.getElementById('ganadaClose').onclick=()=>document.getElementById('ganadaModal').style.display='none';
document.getElementById('toggleLargeText').onclick=()=>{
  document.querySelector('.right-pane').classList.toggle('broadcast-mode');
};
document.getElementById('searchInput').oninput=()=>renderSongList();

// ì´ˆê¸° ì‹¤í–‰
(async()=>{
  await loadLyricsList();
  const tabs = document.getElementById('tabs');
  SHEET_NAMES.slice(1).forEach(name => {
    const t = document.createElement('div'); t.className='tab'; t.textContent=name;
    t.onclick=()=>selectCategory(name, t);
    tabs.appendChild(t);
  });
  const guideRows = await fetchSheet('ì‚¬ìš©ì„¤ëª…ì„œ');
  document.getElementById('guide').innerHTML = guideRows.map(r=>r.map(c=>c?.v||'').join(' ')).join('<br>');
  tabs.firstChild.click();
})();
</script>
</body>
</html>
