<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ìš”ì½”ë§ ë…¸ë˜ì±…</title>
<style>
/* ê¸°ì¡´ ë””ìì¸ ìœ ì§€ */
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;background:#0f1115;color:#eaeaf0;overflow-x:hidden;}
.title-line{display:flex;align-items:center;justify-content:center;gap:12px;margin:15px 0;font-size:24px;color:#eaeaf0;position:sticky;top:0;background:#0f1115;z-index:100;padding:10px 0;}
.youtube-btn{display:flex;align-items:center;gap:6px;background:#ff4f9a;color:#000;font-weight:600;font-size:14px;padding:6px 10px;border-radius:8px;text-decoration:none;}

.container{display:flex;gap:16px;max-width:1200px;margin:0 auto;padding:0 10px 10px;height:calc(100vh - 75px);}
.left-pane{flex:1;max-width:320px;display:flex;flex-direction:column;gap:12px;overflow:hidden;}
.right-pane{flex:2;display:flex;flex-direction:column;overflow:hidden;}

#tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:5px;}
.tab{padding:6px 12px;border-radius:15px;background:#1f2330;color:#cfd3ff;cursor:pointer;font-size:13px;white-space:nowrap;}
.tab.active{background:#ff4f9a;color:#000;font-weight:600;}
.top-controls{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
#searchInput{flex:1;padding:10px;border-radius:8px;border:1px solid #333;background:#181b22;color:#fff;font-size:14px;}

#list{flex:1;overflow-y:auto;background:#0f1115;}
.song{display:flex;gap:10px;padding:12px 8px;border-bottom:1px solid #232736;align-items:center;font-size:14px;cursor:pointer;}
.song:nth-child(odd){background:#15181f;}
.song.selected{background:#251c2a !important;border-left:4px solid #ff4f9a;}
.song .artist{flex:1;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.song .title{flex:1.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

.copy-btn{background:none;border:none;color:#555;cursor:pointer;font-size:16px;padding:0 5px;}
.mr,.lyrics-btn{color:#ff4f9a;font-weight:bold;cursor:pointer;font-size:14px;min-width:40px;text-align:center;}
.disabled{color:#333;pointer-events:none;font-weight:normal;opacity:0.3;}

/* ê°€ì‚¬ ëª¨ë‹¬ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:2000;}
.modal-content{background:#181b22;width:90%;max-width:500px;border-radius:12px;border:2px solid #ff4f9a;position:absolute;overflow:hidden;display:flex;flex-direction:column;}
.modal-header{padding:12px;background:#1f2330;cursor:move;text-align:center;border-bottom:1px solid #333;user-select:none;}
.modal-close{position:absolute;top:8px;right:15px;cursor:pointer;color:#ff4f9a;font-size:26px;font-weight:bold;z-index:10;}
.lyrics-body{padding:20px;max-height:60vh;overflow-y:auto;text-align:center;}
#lyricsText{white-space:pre-wrap;color:#f1f2ff;font-size:16px;margin:0;line-height:1.8;}

@media (max-width: 768px) {
  .container{flex-direction:column;height:auto;}
  .left-pane{max-width:100%;}
  .right-pane{height:60vh;}
}
</style>
</head>
<body>

<h1 class="title-line">ìš”ì½”ë§ ë…¸ë˜ì±… <a href="https://www.youtube.com/@%EC%9A%94%EC%BD%94%EB%A7%81" target="_blank" class="youtube-btn">â–¶ YouTube</a></h1>

<div class="container">
  <div class="left-pane">
    <div id="tabs"></div>
    <div class="artist-controls"><button id="btnGanada" style="padding:6px 12px;border-radius:10px;background:#1f2330;color:#cfd3ff;border:none;cursor:pointer;">ê°€ë‚˜ë‹¤ìˆœ</button></div>
    <div id="artistList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;"></div>
    <div id="guide" style="margin-top:10px;font-size:12px;opacity:0.6;"></div>
  </div>
  <div class="right-pane">
    <div class="top-controls"><input type="text" id="searchInput" placeholder="ê²€ìƒ‰"></div>
    <div id="list"></div>
  </div>
</div>

<div id="lyricsModal" class="modal">
  <div class="modal-content" id="dragTarget">
    <div class="modal-header">ê°€ì‚¬ ë³´ê¸°</div>
    <span id="modalClose" class="modal-close">âœ•</span>
    <div class="lyrics-body"><pre id="lyricsText"></pre></div>
  </div>
</div>

<script>
const SHEET_ID='1bSs04gJ8HyVil5PM0TBAm-4c_BeAqbU7ENMZ2AQcUVI';
const SHEET_NAMES=['ì‚¬ìš©ì„¤ëª…ì„œ','K-POP','POP','J-POP','ìˆ™ì œê³¡','ì‹ ê³¡'];
let currentSongs=[], currentArtist='ì „ì²´', lyricsList=[];

// 1. ê°€ì‚¬ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (í•µì‹¬ ë³µêµ¬)
async function loadLyricsList(){
  try {
    const res = await fetch('data/lyrics_list.json');
    lyricsList = await res.json();
  } catch(e) { console.log("ê°€ì‚¬ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
}

function findLyricsFile(artist, title){
  const found = lyricsList.find(l => l.artist === artist && l.title === title);
  return found ? found.file : null;
}

async function fetchSheet(sheetName){
  const res=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`);
  const text=await res.text();
  const json=JSON.parse(text.substring(47,text.length-2));
  return json.table.rows.map(r => r.c);
}

async function selectCategory(name, tabEl){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tabEl.classList.add('active');
  const rows = await fetchSheet(name);
  currentSongs = rows.slice(1).map(r => {
    if(!r || !r[0] || !r[1]) return null;
    let mrLink = '';
    if (r[6] && String(r[6].v || '').startsWith('http')) mrLink = String(r[6].v);
    else if (r[5] && String(r[5].v || '').startsWith('http')) mrLink = String(r[5].v);
    
    const artist = String(r[0].v || '');
    const title = String(r[1].v || '');

    return {
      artist, title, mr: mrLink,
      lyricsFile: findLyricsFile(artist, title), // íŒŒì¼ ì—¬ë¶€ í™•ì¸
      filterArtist: artist.split('(')[0].trim()
    };
  }).filter(s => s !== null);
  renderArtistFilter(); renderSongList();
}

function renderSongList(){
  const query = document.getElementById('searchInput').value.toLowerCase();
  const listEl = document.getElementById('list'); listEl.innerHTML = '';
  currentSongs.filter(s => (currentArtist==='ì „ì²´' || s.filterArtist===currentArtist) && (s.title.toLowerCase().includes(query) || s.artist.toLowerCase().includes(query)))
    .forEach(s => {
      const div = document.createElement('div'); div.className = 'song';
      const mrBtn = s.mr ? `<a class="mr" href="${s.mr}" target="_blank">MR</a>` : `<span class="mr disabled">MR</span>`;
      
      // ê°€ì‚¬ íŒŒì¼ì´ ìˆì„ ë•Œë§Œ í•‘í¬ìƒ‰, ì—†ìœ¼ë©´ íšŒìƒ‰/ë¹„í™œì„±
      const lyricsBtn = s.lyricsFile 
        ? `<span class="lyrics-btn" onclick="showLyrics('${s.lyricsFile}')">ê°€ì‚¬</span>` 
        : `<span class="lyrics-btn disabled">ê°€ì‚¬</span>`;
      
      div.innerHTML = `
        <button class="copy-btn" onclick="copyText('${s.artist}-${s.title}', this); event.stopPropagation();">ğŸ“‹</button>
        <span class="artist">${s.artist}</span>
        <span class="title">${s.title}</span>
        ${mrBtn}${lyricsBtn}
      `;
      div.onclick = () => { document.querySelectorAll('.song').forEach(x=>x.classList.remove('selected')); div.classList.add('selected'); };
      listEl.appendChild(div);
    });
}

function showLyrics(file){
  fetch(`data/lyrics/${file}`).then(r => r.text()).then(t => {
    document.getElementById('lyricsText').textContent = t;
    document.getElementById('lyricsModal').style.display = 'flex';
  }).catch(() => alert("ê°€ì‚¬ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
}

// ê°€ë‚˜ë‹¤ìˆœ í•„í„°, ë“œë˜ê·¸ ë¡œì§ ë“±ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
function renderArtistFilter(){
  const map={}; currentSongs.forEach(s=>{ map[s.filterArtist]=(map[s.filterArtist]||0)+1; });
  const sorted = Object.keys(map).sort((a,b)=>map[b]-map[a]);
  const listEl = document.getElementById('artistList'); listEl.innerHTML = '';
  ['ì „ì²´', ...sorted].forEach(a => {
    const btn = document.createElement('div'); btn.className = 'tab' + (currentArtist===a?' active':'');
    btn.textContent = a + (a==='ì „ì²´'?'':`(${map[a]})`);
    btn.onclick = () => { currentArtist=a; renderArtistFilter(); renderSongList(); };
    listEl.appendChild(btn);
  });
}

function copyText(txt, btn){ navigator.clipboard.writeText(txt).then(() => { btn.textContent='âœ…'; setTimeout(()=>btn.textContent='ğŸ“‹', 1000); }); }

// ë“œë˜ê·¸ ë¡œì§
let isDragging = false, xOffset = 0, yOffset = 0, initialX, initialY;
const dragTarget = document.getElementById("dragTarget");
const modalHeader = document.querySelector(".modal-header");
modalHeader.addEventListener("mousedown", dragStart);
modalHeader.addEventListener("touchstart", dragStart);
function dragStart(e) {
  initialX = (e.type === "touchstart" ? e.touches[0].clientX : e.clientX) - xOffset;
  initialY = (e.type === "touchstart" ? e.touches[0].clientY : e.clientY) - yOffset;
  isDragging = true;
}
function drag(e) {
  if (isDragging) {
    e.preventDefault();
    const currentX = (e.type === "touchmove" ? e.touches[0].clientX : e.clientX) - initialX;
    const currentY = (e.type === "touchmove" ? e.touches[0].clientY : e.clientY) - initialY;
    xOffset = currentX; yOffset = currentY;
    dragTarget.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
  }
}
document.addEventListener("mousemove", drag); document.addEventListener("mouseup", () => isDragging = false);
document.addEventListener("touchmove", drag, {passive: false}); document.addEventListener("touchend", () => isDragging = false);

document.getElementById('modalClose').onclick=()=>document.getElementById('lyricsModal').style.display='none';
window.onclick=(e)=>{ if(e.target.classList.contains('modal')) e.target.style.display='none'; };
document.getElementById('searchInput').oninput=()=>renderSongList();

(async()=>{
  await loadLyricsList(); // ê°€ì‚¬ ëª©ë¡ ë¨¼ì € ë¡œë“œ
  const tabs = document.getElementById('tabs');
  SHEET_NAMES.slice(1).forEach(name => {
    const t = document.createElement('div'); t.className='tab'; t.textContent=name;
    t.onclick=()=>selectCategory(name, t); tabs.appendChild(t);
  });
  const guideRows = await fetchSheet('ì‚¬ìš©ì„¤ëª…ì„œ');
  document.getElementById('guide').innerHTML = guideRows.map(r=>r?r[0]?.v||'':'').join('<br>');
  tabs.firstChild.click();
})();
</script>
</body>
</html>
