<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>요코링 노래책</title>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;background:#0f1115;color:#eaeaf0;}
.title-line{display:flex;align-items:center;justify-content:center;gap:16px;margin:24px 0 16px;font-size:28px;color:#eaeaf0;}
.youtube-btn{display:flex;align-items:center;gap:6px;background:#ff4f9a;color:#000;font-weight:600;font-size:16px;padding:6px 12px;border-radius:8px;text-decoration:none;transition:0.15s;}
.youtube-btn:hover{transform:scale(1.05);background:#ff78b2;}
.container{max-width:1200px;margin:0 auto;padding:0 16px 40px;display:flex;gap:16px;}
.left-panel{flex:1;display:flex;flex-direction:column;}
.guide{background:#181b22;border-radius:12px;padding:16px;margin-bottom:12px;font-size:14px;line-height:1.6;color:#cfd3ff;}
.category-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px;}
.tab{padding:8px 14px;border-radius:20px;background:#1f2330;color:#cfd3ff;cursor:pointer;font-size:14px;user-select:none;}
.tab.active{background:#ff4f9a;color:#000;font-weight:600;}
.alpha-toggle-container{display:flex;gap:6px;margin-bottom:8px;align-items:center;}
.alpha-toggle{padding:6px 12px;background:#1f2330;color:#cfd3ff;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:4px;}
.alpha-toggle:hover{background:#6c7bff;color:#000;font-weight:600;}
.artist-filter{max-height:360px;overflow-y:auto;background:#181b22;border-radius:12px;padding:8px;display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.artist{padding:6px 12px;border-radius:14px;background:#1f2330;font-size:13px;cursor:pointer;color:#cfd3ff;white-space:nowrap;}
.artist.active{background:#6c7bff;color:#000;font-weight:600;}
.right-panel{flex:2;display:flex;flex-direction:column;max-height:80vh;overflow-y:auto;}
.top-controls{display:flex;gap:8px;margin-bottom:12px;align-items:center;}
#searchInput{padding:6px 12px;border-radius:8px;border:none;font-size:14px;flex-shrink:0;}
#toggleLargeText{padding:6px 12px;border-radius:6px;background:#ff4f9a;color:#000;border:none;cursor:pointer;font-size:14px;flex-shrink:0;}
.list .song{display:grid;grid-template-columns:1.4fr 2fr auto auto auto auto auto;gap:8px;padding:12px 8px;border-bottom:1px solid #232736;align-items:center;font-size:15px;cursor:pointer;transition:0.2s;}
.list .song:hover{background:#1f2030;}
.song strong{font-size:15.5px;font-weight:600;color:#fff;}
.song>div{font-size:14.5px;color:#eaeaf0;}
.song small{font-size:12.5px;color:#aab0ff;}
.mr,.lyrics-btn{color:#ff4f9a;font-weight:bold;cursor:pointer;white-space:nowrap;font-size:14px;}
.disabled{color:#555;pointer-events:none;font-weight:normal;}
.song.selected{background:#1f2230;border-left:4px solid #ff4f9a;border-radius:6px;box-shadow:0 2px 10px rgba(255,79,154,0.3);}
.song.selected strong{color:#ff4f9a;font-size:16px;}
.song.selected div{color:#fff;font-weight:600;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:999;}
.modal-content{background:#181b22;padding:30px 40px;max-width:600px;max-height:80%;overflow-y:auto;border-radius:12px;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border:2px solid #ff4f9a;}
.modal-close{position:absolute;top:10px;right:15px;cursor:pointer;font-weight:bold;color:#ff4f9a;}
.alpha-modal-item{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;font-size:13px;color:#cfd3ff;padding:6px 12px;cursor:pointer;border-bottom:1px solid #333;}
.alpha-modal-item:hover{background:#6c7bff;color:#000;font-weight:600;}
@media(max-width:720px){.song{grid-template-columns:1fr 1.6fr auto auto auto;}.song .memo,.song .key{display:none;}#searchInput{flex-basis:100%;margin-left:0;}}
</style>
</head>
<body>
<h1 class="title-line">
  요코링 노래책
  <a href="https://www.youtube.com/@%EC%9A%94%EC%BD%94%EB%A7%81" target="_blank" class="youtube-btn">▶ 요코링 YouTube</a>
</h1>

<div class="container">
  <div class="left-panel">
    <div class="category-tabs" id="tabs"></div>
    <div class="alpha-toggle-container">
      <div class="alpha-toggle" id="alphaToggle">가나다순 ⇅</div>
    </div>
    <div id="artistFilter" class="artist-filter"></div>
    <div id="guide" class="guide"></div>
  </div>
  <div class="right-panel">
    <div class="top-controls">
      <input type="text" id="searchInput" placeholder="곡 검색">
      <button id="toggleLargeText">큰 글씨모드</button>
    </div>
    <div id="listWrapper">
      <div id="list" class="list"></div>
    </div>
  </div>
</div>

<div id="lyricsModal" class="modal">
  <div class="modal-content">
    <span id="modalClose" class="modal-close">✕</span>
    <div id="lyricsText"></div>
  </div>
</div>

<script>
const SHEET_ID='1bSs04gJ8HyVil5PM0TBAm-4c_BeAqbU7ENMZ2AQcUVI';
const SHEET_NAMES=['사용설명서','K-POP','POP','J-POP','숙제곡','신곡'];
const guideEl=document.getElementById('guide');
const tabsEl=document.getElementById('tabs');
const listEl=document.getElementById('list');
const listWrapper=document.getElementById('listWrapper');
const artistFilterEl=document.getElementById('artistFilter');
const alphaToggle=document.getElementById('alphaToggle');
const lyricsModal=document.getElementById('lyricsModal');
const lyricsText=document.getElementById('lyricsText');
const modalClose=document.getElementById('modalClose');
const searchInput=document.getElementById('searchInput');
const toggleBtn=document.getElementById('toggleLargeText');

let currentSongs=[],currentArtist='전체',lyricsList=[],largeTextOn=false,selectedSongIndex=null;

/* ====================== 데이터 로드 ====================== */
async function fetchSheet(sheetName){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const res=await fetch(url);
  const text=await res.text();
  const json=JSON.parse(text.substring(47,text.length-2));
  return json.table.rows.map(r=>r.c.map(c=>c?c.v:''));
}

async function loadLyricsList(){
  const res=await fetch('data/lyrics_list.json');
  lyricsList=await res.json();
}

function findLyricsFile(artist,title){
  const found=lyricsList.find(l=>l.artist===artist && l.title===title);
  return found?found.file:null;
}

function normalizeArtist(name){return name.replace(/(\([^)]*feat[^)]*\))/i,'').replace(/feat.*$/i,'').trim();}

/* ====================== UI 렌더 ====================== */
function renderTabs(){
  SHEET_NAMES.slice(1).forEach(name=>{
    const tab=document.createElement('div');
    tab.className='tab';
    tab.textContent=name;
    tab.onclick=()=>selectCategory(name,tab);
    tabsEl.appendChild(tab);
  });
}

async function loadGuide(){
  const rows=await fetchSheet('사용설명서');
  guideEl.innerHTML=rows.map(r=>r.join(' ')).join('<br>');
}

function renderArtistFilter(songs){
  const set=new Set(songs.map(s=>s.filterArtist));
  const artists=['전체',...Array.from(set).sort((a,b)=>b.length-a.length)]; // 내림차순
  artistFilterEl.innerHTML='';
  artists.forEach(a=>{
    const btn=document.createElement('div');
    btn.className='artist'+(a==='전체'?' active':'');
    btn.textContent=a;
    btn.onclick=()=>{
      if(currentArtist===a){currentArtist='전체';}else{currentArtist=a;}
      document.querySelectorAll('.artist').forEach(x=>x.classList.remove('active'));
      [...document.querySelectorAll('.artist')].find(x=>x.textContent===currentArtist)?.classList.add('active');
      renderSongList(searchInput.value.toLowerCase());
      [...document.querySelectorAll('.artist')].find(x=>x.textContent===currentArtist)?.scrollIntoView({behavior:"smooth",block:"center"});
    };
    artistFilterEl.appendChild(btn);
  });
  artistFilterEl.style.display='flex';
}

function renderSongList(searchQuery=''){
  listEl.innerHTML='';
  const filtered=currentSongs.filter(s=>(currentArtist==='전체'||s.filterArtist===currentArtist)&&(s.title.toLowerCase().includes(searchQuery)||s.artist.toLowerCase().includes(searchQuery)));
  filtered.forEach((s,index)=>{
    const div=document.createElement('div');
    div.className='song';
    const mrBtn=s.mr?`<a class="mr" href="${s.mr}" target="_blank">MR</a>`:`<span class="mr disabled">MR</span>`;
    const lyricsBtn=s.lyricsFile?`<span class="lyrics-btn" onclick="showLyrics('${s.lyricsFile}')">가사</span>`:`<span class="lyrics-btn disabled">가사</span>`;
    div.innerHTML=`<strong>${s.artist}</strong><div>${s.title}</div><small class="memo">${s.memo||''}</small><small>${s.keyUp||''}</small><small class="key">${s.key||''}</small>${mrBtn}${lyricsBtn}`;
    listEl.appendChild(div);
    div.onclick=()=>{
      document.querySelectorAll('.song').forEach(s=>s.classList.remove('selected'));
      div.classList.add('selected');
      selectedSongIndex=index;
      div.scrollIntoView({behavior:"smooth",block:"center"});
    };
  });
}

/* ====================== 가사 모달 ====================== */
function showLyrics(file){
  fetch(`data/lyrics/${file}`).then(res=>res.text()).then(text=>{
    lyricsText.textContent=text;
    lyricsModal.style.display='flex';
  }).catch(()=>{lyricsText.textContent='가사를 불러올 수 없습니다.';lyricsModal.style.display='flex';});
}
modalClose.onclick=()=>lyricsModal.style.display='none';
lyricsModal.onclick=e=>{if(e.target===lyricsModal)lyricsModal.style.display='none';};

/* ====================== 검색 ====================== */
searchInput.addEventListener('input',()=>renderSongList(searchInput.value.toLowerCase()));

/* ====================== 큰 글씨모드 ====================== */
toggleBtn.onclick=()=>{
  largeTextOn=!largeTextOn;
  listWrapper.style.fontSize=largeTextOn?'1.35em':'1em';
};

/* ====================== 카테고리 선택 ====================== */
async function selectCategory(name,tabEl){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tabEl.classList.add('active');
  listEl.style.display='block';
  artistFilterEl.style.display='none';
  currentArtist='전체';
  currentSongs=[];
  const rows=await fetchSheet(name);
  rows.forEach(r=>{if(!r[0]||!r[1])return;currentSongs.push({artist:r[0],filterArtist:normalizeArtist(r[0]),title:r[1],memo:r[2],keyUp:r[3],key:r[4],mr:r[5],lyricsFile:findLyricsFile(r[0],r[1])});});
  renderArtistFilter(currentSongs);
  renderSongList(searchInput.value.toLowerCase());
}

/* ====================== 가나다순 모달 ====================== */
alphaToggle.onclick=()=>{
  lyricsText.innerHTML='';
  const sorted=[...new Set(currentSongs.map(s=>s.filterArtist))].sort((a,b)=>a.localeCompare(b));
  sorted.forEach(a=>{
    const div=document.createElement('div');
    div.textContent=a;
    div.className='alpha-modal-item';
    div.onclick=()=>{
      currentArtist=a;
      renderSongList(searchInput.value.toLowerCase());
      document.querySelectorAll('.artist').forEach(x=>x.classList.remove('active'));
      const activeEl=[...document.querySelectorAll('.artist')].find(x=>x.textContent===a);
      if(activeEl){activeEl.classList.add('active');activeEl.scrollIntoView({behavior:'smooth',block:'center'});}
      lyricsModal.style.display='none';
    };
    lyricsText.appendChild(div);
  });
  lyricsModal.style.display='flex';
};

/* ====================== 초기 실행 ====================== */
(async()=>{
  await loadLyricsList();
  renderTabs();
  loadGuide();
})();
</script>
</body>
</html>
